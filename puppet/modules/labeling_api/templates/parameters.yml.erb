# This file is auto-generated during the composer install
parameters:
    cache_dir: <%= @cache_dir %>

    database_host: <%= @database_host %>
    database_port: <%= @database_port %>
    database_name: <%= @database_name %>
    database_user: <%= @database_user %>
    database_password: <%= @database_password %>

    couchdb_host: <%= @couchdb_host %>
    couchdb_port: <%= @couchdb_port %>
    couchdb_user: <% if @couchdb_user != nil %><%= @couchdb_user %><% else %>~<% end %>
    couchdb_password: <% if @couchdb_password != nil %><%= @couchdb_password %><% else %>~<% end %>

    mailer_transport: <%= @mailer_transport %>
    mailer_host: <%= @mailer_host %>
    mailer_user: <%= @mailer_user %>
    mailer_password: <%= @mailer_password %>

    secret: <%= @secret %>

    ffmpeg_executable: <%= @ffmpeg_executable %>
    ffprobe_executable: <%= @ffprobe_executable %>

    frame_cdn_dir: <%= @frame_cdn_dir %>

    <% if @frame_cdn_type == 's3' %>
    frame_cdn_s3_base_url: <%= @frame_cdn_s3_base_url %>
    frame_cdn_s3_region: <%= @frame_cdn_s3_region %>
    frame_cdn_s3_bucket: <%= @frame_cdn_s3_bucket %>
    frame_cdn_s3_key: <%= @frame_cdn_s3_key %>
    frame_cdn_s3_secret: <%= @frame_cdn_s3_secret %>
    <% end %>

    <% if @frame_cdn_type == 's3-cmd' %>
    s3cmd_executable: "<%= @s3cmd_executable %>"
    parallel_executable: "<%= @parallel_executable %>"
    frame_cdn_s3_parallel_uploads_per_worker: "<%= @frame_cdn_s3_parallel_uploads_per_worker %>"
    frame_cdn_s3_host_base: "<%= @frame_cdn_s3_host_base %>"
    frame_cdn_s3_host_bucket: "<%= @frame_cdn_s3_host_bucket %>"
    frame_cdn_s3_bucket: "<%= @frame_cdn_s3_bucket %>"
    frame_cdn_s3_key: "<%= @frame_cdn_s3_key %>"
    frame_cdn_s3_secret: "<%= @frame_cdn_s3_secret %>"
    <% end %>

    frame_cdn_base_url: <%= @frame_cdn_base_url %>

    <% if @user_password != nil %>
    user_password: <%= @user_password %>
    <% end %>

    rabbitmq_host: <%= @rabbitmq_host %>
    rabbitmq_port: <%= @rabbitmq_port %>
    rabbitmq_vhost: <%= @rabbitmq_vhost %>
    rabbitmq_user: <%= @rabbitmq_user %>
    rabbitmq_password: <%= @rabbitmq_password %>
    rabbitmq_use_alternate_exchange: <%= @rabbitmq_use_dead_letter_exchange %>
    rabbitmq_use_dead_letter_exchange: <%= @rabbitmq_use_alternate_exchange %>
    rabbitmq_management_port: <%= @rabbitmq_management_port %>

    redis_host: <%= @redis_host %>
    redis_port: <%= @redis_port %>

<% if @frame_cdn_type == 'filesystem' %>
oneup_flysystem:
    adapters:
        frame_cdn_dir_adapter:
            local:
                directory: %frame_cdn_dir%
<% end %>

<% if @frame_cdn_type == 's3' %>
oneup_flysystem:
    adapters:
            frame_cdn_dir_adapter:
                awss3v3:
                    client: frame_cdn.s3_client
                    bucket: "%frame_cdn_s3_bucket%"

services:
    frame_cdn.s3_client:
        class: Aws\S3\S3Client
        arguments:
            -
                version: 'latest'
                region: "%frame_cdn_s3_region%"
                endpoint: '%frame_cdn_s3_base_url%'
                validate: false
                bucket_endpoint: true
                credentials:
                    key: "%frame_cdn_s3_key%"
                    secret: "%frame_cdn_s3_secret%"
<% end %>

<% if @frame_cdn_type == 's3-cmd' %>
oneup_flysystem:
    adapters:
        frame_cdn_dir_adapter:
            local:
                directory: %frame_cdn_dir%

services:
    annostation.labeling_api.service.s3_cmd_uploader:
        class: AppBundle\Service\S3CmdUploader
        arguments:
            - '%s3cmd_executable%'
            - '%parallel_executable%'
            - '%frame_cdn_s3_parallel_uploads_per_worker%'
            - '%cache_dir%'
            - '%frame_cdn_s3_bucket%'
            - '%frame_cdn_s3_key%'
            - '%frame_cdn_s3_secret%'
            - '%frame_cdn_s3_host_base%'
            - '%frame_cdn_s3_host_bucket%'

    annostation.labeling_api.service.frame_cdn.s3_cmd:
        class: AppBundle\Service\FrameCdn\S3Cmd
        arguments:
            - '%frame_cdn_base_url%'
            - '%cache_dir%'
            - '@annostation.labeling_api.service.s3_cmd_uploader'

    annostation.labeling_api.service.frame_cdn.selected-alias:
        alias: annostation.labeling_api.service.frame_cdn.s3_cmd
<% end %>
