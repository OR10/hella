<?xml version="1.0" encoding="UTF-8" ?>
<workflow xmlns="http://weblabel.hella-aglaia.com/schema/workflow">
  <!--
    Phase: A specific labeling phase executed by specific team and label coordinator

    There may exist an arbitrary amount of phases. Each phase automatically depends on the one before it.
    Phases may only be entered once there dependecy is markes finished.
    Phases may not be executed in parallel.

    Each phase may use a certain `conflict-resolution` strategy. The first implementation will only feature one version
    of it. In the future however additional strategies may be implemented.

    The initial version `flag-and-revisionÂ´ will allow the labeler to flag inconsistencies at any point. After flagging
    flagging by a labeler he/she continues labeling. Flagged things will not be considered for the `complete` check of
    the task. After the current labeling "branch" is completed a review/revision task will be created in which all of
    the before labeled information may be checked and altered to be correct. After this the labeling is resumed with the
    next available phase.
  -->
  <phase id="labeling"
         name="Labeling"
         conflict-resolution="flag-and-revision">
    <!--
      Task: A specific task executed by one labeler.

      Tasks may be executed in parallel by multiple labelers, depending on the tasks defined prerequisites.
      Tasks contain a specific set of operations (classification, drawing) to be executed by the labeler.
      Different task types exist, specifying in which way the task is executed (simple, focus-on-thing, ...).
      Available things to be used within the task may be filtered using the `thing-filter` attribute.
    -->
    <task id="frame" name="Frame labeling">
      <!--
        Frame classification: An operation classifying global (frame-based) attributes of the video.

        A common set of frame based attributes may be something like: country, weather, street-type, ...
      -->
      <classify-frame />
    </task>

    <task after="frame" id="speed-sign-mapping" name="Speed signs">
      <!--
        Tasks may provide an optional description block, specifying what the labeler should do exactly.
      -->
      <description>
        Deine Aufgabe ist folgendes: Schilder labeln
      </description>

      <!--
        Draw Operation: Manipulation/Creation of Shapes (things).

        Drawing operations include the modification as well as creation of any defined thing (see requirements).
        An arbitrary amount of different drawing operations is allowed in one task
      -->
      <draw thing="sign" />
    </task>

    <task after="speed-sign-mapping"
          id="speed-sign-classification"
          name="Classify speed signs">
      <!--
        Classification Operation: Classify any defined thing

        Classification operations are based on things defined in the `requirements.xml` file.
        They may be further limited using allow-filters, which are nested within them.
        Classification operations may specify a `max-depth` property to limit the levels of classes to be classified.

        If no further `<allow>` tag is specified the operation assumes all classes should be labeled
      -->
      <classify thing="sign">
        <!--
          If at least one `allow` is specified only those classes/values listed within it are allowed for
          the defined classification. Every other attribute will not be provided for labeling.
        -->
        <allow class="sign-type" max-depth="1">
          <allow value="u-turn" />
          <allow value="prohibited" />
        </allow>
      </classify>
    </task>

    <!--
      The next 3 tasks describe the drawing and grouping of time range extension signs for speed signs.
    -->
    <task id="time-range-sign-mapping" name="Time Range Signs">
      <description>
        Please draw boxes around every time range sign.
      </description>

      <draw thing="time-range-sign" />
    </task>

    <task after="time-range-sign-mapping"
          id="time-range-sign-classification"
          name="Time Range Sign Classification"
          thing-filter="thing:time-range-sign"
          type="focus-on-thing">
      <description>
        Please classify all time range signs
      </description>

      <classify thing="time-range-sign" />
    </task>

    <task after="time-range-sign-mapping, speed-sign-mapping"
          id="time-range-speed-sign-grouping"
          name="Time Range Sign / Speed Sign grouping"
          thing-filter="thing:time-range-sign OR thing:speed-sign">
      <description>
        Please group all time range signs with their corresponding speed-signs and classify them.
      </description>

      <draw group="extension-sign-group" />
      <classify group="extension-sign-group" />
    </task>

    <!--
     `thing-filter` may be used to limit the process to a set of Things with specific attributes.
     Using this feature allows the subdivision of complex tasks into smaller non dependant tasks, which
     are easier to process, as well as solvable by different lablers in parallel.

     Logical expressions are evaluated against all value and class identifiers.
     Values are true if the corresponding attribute is set.
     Classes are true if any of its direct child values is set.

     Logical values are prefixed with their context, either `frame:` or `thing:`.
    -->
    <task after="speed-sign-mapping, frame"
          id="speed-signs-on-country-road"
          name="Speed signs on country roads"
          thing-filter="thing:speed-sign AND frame:country"
    >
      <classify thing="sign" max-depth="1" />
    </task>

    <!--
      The `type` selects a specific labeling view. For example `focus-on-thing` will somehow highlight or emphasize
      the Thing to be processed. (UX to be discussed here: may be zooming in on each Thing).

      Different types are possible in the future. Providing the `type` `simple` or the not specifying a `type` at all
      represents the normal, currently used, free form label process based on frames.
    -->
    <task after="speed-sign-mapping, frame"
          id="speed-signs-on-highway"
          name="Speed signs on highways"
          thing-filter="thing:speed-sign AND frame:highway"
          type="focus-on-thing">
      <classify thing="sign">
        <allow class="speed-sign" />
      </classify>
    </task>

    <!--
      Multiple dependencies in `after` are treated as a combined logical AND. All of the mentioned tasks in this list
      must be completed, before this one is allowed to be started. The list is separated by comma.
    -->
    <task after="frame, speed-signs-on-country-road, speed-signs-on-highway"
          id="light"
          name="Lights"
          thing-filter="frame:night AND thing:light-source AND (thing:direction-forward OR thing:stationary)"
    >
      <classify thing="light-source">
        <allow class="light-source">
          <allow value="street-light" />
          <allow value="car" />
          <allow value="advertisement" />
        </allow>
        <allow class="direction">
          <allow value="front" />
          <allow value="stationary" />
        </allow>
      </classify>
    </task>
  </phase>

  <phase id="review" name="Review">
    <!--
      Tasks may either be defined as seen above, or be referenced in other phases, to be reused the
      same way as before.

      No further attributes are allowed on a `task` if a reference is used.
    -->
    <task ref="frame" />
    <task ref="speed-sign-mapping" />
    <task ref="speed-signs-on-country-road" />
    <task ref="speed-signs-on-highway" />
    <task ref="light" />
  </phase>

  <phase id="revision-1" name="Revision 1">
    <!--
      Labelers which are allowed for a certain phase may optionally be restricted to enforce a double-verification
      principle for example.

      The specific restrictions may be extended in the future with further implementations if the need for those should
      arise.
    -->
    <restrict-labelers>
      <not-same-label-coordinator />
      <!--
        All current restrictions may be limited to a specific or a comma seperated list of multiple before executed
        phases. Therefore it may be specified, that the labeling-group, who has done the review may not be the one doing
        the revision. The labeling-group, who did the labeling however may be allowed to execute the revision.
      -->
      <not-same-label-group from-phase="labeling" />
    </restrict-labelers>

    <task id="all-over-revision" name="Revision">
      <draw thing="sign" />
      <classify thing="sign" />

      <draw thing="time-range-sign" />
      <classify thing="time-range-sign" />

      <draw group="extension-sign-group" />
      <classify group="extension-sign-group" />
    </task>
  </phase>

  <phase id="revision-2" name="Revision 2">
    <!--
      For referenced tasks a special much more fine grained restriction may be used.

      If a task is referenced from an earlier phase it is possible to restrict it by labler instead of restricting it
      by group or coordinator. This is possible, as the corresponding reference can be analysed for the specific labeler,
      who labeled it. Therefore a fine grained restriction is possible only allowing another labeler to do a second
      correction of the task for example. The label-coordinator and/or label-group may be the same however (if not
      forbidden by other restriction).
    -->
    <restrict-labelers>
      <not-same-labeler-for-referenced-tasks from-phase="revision-1" />
    </restrict-labelers>

    <task ref="all-over-revision" />
  </phase>
</workflow>
